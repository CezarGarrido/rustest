name: Build for Windows 32-bit

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        target: i686-pc-windows-msvc
        override: true

    - name: Install GTK dependencies
      run: |
        # Baixar e extrair o GTK para Windows
        Invoke-WebRequest -Uri "https://github.com/miegir/GTK-for-Windows-Runtime-Environment-Installer-32/releases/download/2021-12-08/gtk3-runtime-3.24.30-2021-12-08-ts-win32.exe" -OutFile "gtk-runtime.exe"
        Start-Process -FilePath "gtk-runtime.exe" -ArgumentList "/S" -Wait
        # Configurar o pkg-config para cross-compilation
        $gtkPath = "C:\gtk3"
        [System.Environment]::SetEnvironmentVariable("PKG_CONFIG_ALLOW_CROSS", "1", [System.EnvironmentVariableTarget]::Process)
        [System.Environment]::SetEnvironmentVariable("PKG_CONFIG_PATH", "$gtkPath\lib\pkgconfig", [System.EnvironmentVariableTarget]::Process)
        [System.Environment]::SetEnvironmentVariable("PATH", "$env:PATH;$gtkPath\bin", [System.EnvironmentVariableTarget]::Process)
        echo "GTK_PATH=$gtkPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PKG_CONFIG_ALLOW_CROSS=1" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        echo "PKG_CONFIG_PATH=$gtkPath\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        
    - name: Install Rust target
      run: rustup target add i686-pc-windows-msvc

    - name: Build the project
      run: cargo build --target i686-pc-windows-msvc --release

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-32bit-release
        path: target/i686-pc-windows-msvc/release/printer_test.exe


